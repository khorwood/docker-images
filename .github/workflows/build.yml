name: build
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
permissions:
  packages: write
jobs:
  alpine:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - run: |
          ./fetch-minirootfs.sh v${{ env.VERSION }} ${{ env.RELEASE }}
          docker buildx build \
              -t ghcr.io/khorwood/alpine:${{ env.VERSION }} \
              -t ghcr.io/khorwood/alpine:${{ env.RELEASE }} .
        env:
          VERSION: 3.22
          RELEASE: 3.22.2
        working-directory: alpine
      - name: docker login
        if: github.ref == 'refs/heads/main'
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: docker push
        if: github.ref == 'refs/heads/main'
        run: docker push -a ghcr.io/khorwood/alpine
        working-directory: alpine
  images:
    runs-on: ubuntu-latest
    needs: [alpine]
    strategy:
      matrix:
        include:
          - image: irssi
            release: 1.4.5-r4
          - image: prometheus
            release: 2.53.4-r5
          - image: radarr
            release: 5.28.0.10274
          - image: sabnzbd
            release: 4.5.5
          - image: sonarr
            release: 4.0.15.2941
    steps:
      - uses: actions/checkout@v5
      - run: |
          docker buildx build --build-arg RELEASE=${{ env.RELEASE }} \
            -t ghcr.io/khorwood/${{ matrix.image }}:${{ env.RELEASE }}-${{ github.run_number }} \
            -t ghcr.io/khorwood/${{ matrix.image }}:${{ env.RELEASE }} \
            -t ghcr.io/khorwood/${{ matrix.image }}:latest \
            .
        env:
          RELEASE: ${{ matrix.release }}
        working-directory: ${{ matrix.image }}
      - name: docker login
        if: github.ref == 'refs/heads/main'
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: docker push
        if: github.ref == 'refs/heads/main'
        run: docker push --all-tags ghcr.io/khorwood/${{ matrix.image }}
        working-directory: ${{ matrix.image }}
